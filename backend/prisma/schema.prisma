// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator py {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
  previewFeatures      = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuidOssp(map: "uuid-ossp")]
}

enum Role {
  VIEWER
  ENGINEER
  ADMIN
  OWNER // ถ้าไม่ใช้ Owner ให้ลบบรรทัดนี้ได้
}

enum OtpPurpose {
  VERIFY_EMAIL
  LOGIN
  RESET_PASSWORD
}

enum AuditAction {
  USER_REGISTER
  USER_LOGIN
  USER_LOGOUT
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  ENABLE_TOTP
  DISABLE_TOTP
  REGISTER_PASSKEY
  REMOVE_PASSKEY
  PROMOTE_ROLE
  DEMOTE_ROLE
  PASSWORD_CHANGE
  PASSWORD_RESET
}

// ========= Core User =========
model User {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String  @unique
  name          String?
  surname       String?
  password      String
  role          Role    @default(VIEWER)
  emailVerified Boolean @default(false)

  /// สะดวกสำหรับ query เร็ว ๆ (อัปเดตจากแอปเมื่อเปิด/ปิด TOTP/Passkey)
  hasStrongMfa Boolean @default(false)

  // Relations (MFA)
  totp          UserTotp?
  passkeys      WebauthnCredential[]
  recoveryCodes RecoveryCode[]
  otps          EmailOtp[]

  // Audit
  actorLogs  AuditLog[] @relation("AuditActor")
  targetLogs AuditLog[] @relation("AuditTarget")

  // Device Network Credentials
  deviceCredentials DeviceCredentials?

  // Policy
  createdPolicies Policy[]

  // OS File Uploads
  uploadedOSFiles OSFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([emailVerified])
  @@index([role])
}

// ========= TOTP (1:1 ต่อผู้ใช้) =========
model UserTotp {
  /// ใช้ userId เป็น PK เพื่อบังคับให้มีได้คนละเรคอร์ด
  userId String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// เก็บ secret แบบเข้ารหัส (Bytes เหมาะกับ Postgres/SQLite; ถ้าบาง DB ไม่รองรับ ใช้ String + เข้ารหัส/เข้มงวดเอง)
  secret         Bytes
  enabled        Boolean   @default(false)
  secretVersion  Int? // ใช้กำกับ key rotation ถ้ามี KMS
  createdAt      DateTime  @default(now())
  lastVerifiedAt DateTime?
}

// ========= Passkey/WebAuthn (หลายคีย์ต่อผู้ใช้) =========
model WebauthnCredential {
  /// credentialId (base64url) เป็น PK
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// publicKey (COSE) เก็บเป็น Bytes; ถ้า DB ไม่รองรับ Bytes ให้ใช้ String base64
  publicKey      Bytes
  signCount      Int      @default(0)
  transports     String[] // Postgres array; ถ้าใช้ DB อื่น ใช้ Json แทน
  attestationFmt String?
  aaguid         String? // อุปกรณ์ (ถ้ามี)
  nickname       String?

  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?

  @@unique([userId, nickname], map: "webauthn_user_nickname_unique")
  @@index([userId])
}

// ========= Recovery Codes (แนะนำให้มี) =========
model RecoveryCode {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// เก็บ "แฮช" ของโค้ดเท่านั้น ห้ามเก็บค่า plaintext
  codeHash  String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([userId, codeHash])
  @@index([userId, usedAt])
}

// ========= Email OTP (สำหรับยืนยันสมัคร/ล็อกอินแบบ OTP) =========
model EmailOtp {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String     @db.Uuid
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash   String // เก็บเป็นแฮช
  purpose    OtpPurpose
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime   @default(now())

  @@index([userId, purpose])
  @@index([expiresAt])
}

// ========= Audit Log (โปร่งใส/ตรวจสอบย้อนหลัง) =========
model AuditLog {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  actorUserId String? @db.Uuid
  actor       User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  targetUserId String? @db.Uuid
  target       User?   @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  action    AuditAction
  details   Json?
  createdAt DateTime    @default(now())

  @@index([actorUserId])
  @@index([targetUserId, action])
}

// ========= Device Network Credentials =========
model DeviceCredentials {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// ชื่อผู้ใช้สำหรับเข้าใช้งานอุปกรณ์เครือข่าย
  deviceUsername String

  /// รหัสผ่านสำหรับเข้าใช้งานอุปกรณ์เครือข่าย (เก็บเป็น hash)
  devicePasswordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ========= Management Network =================

// ========= Device Network =========
model DeviceNetwork {
  id                        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serial_number             String       @unique
  device_name               String
  device_model              String
  type                      TypeDevice   @default(SWITCH)
  status                    StatusDevice @default(OFFLINE)
  ip_address                String?
  mac_address               String       @unique
  description               String?
  phpipam_address_id        String? // phpIPAM address ID for device management IP
  policy_id                 String?      @db.Uuid
  os_id                     String?      @db.Uuid
  backup_id                 String?      @db.Uuid
  local_site_id             String?      @db.Uuid
  configuration_template_id String?      @db.Uuid

  // ========= NBI/ODL Fields =========
  node_id String?      @unique // ODL node-id (เช่น "openflow:1" หรือ "CSR1000vT")
  vendor  DeviceVendor @default(OTHER) // Vendor สำหรับเลือก driver

  // ฟิลด์ใหม่สำหรับการแยกประเภท SDN
  management_protocol ManagementProtocol @default(NETCONF)
  datapath_id         String?            @unique // สำหรับ OpenFlow (เช่น "0000000000000001") กรณี NETCONF ปล่อยเป็น Null

  odl_mounted           Boolean             @default(false) // Mount status ใน ODL
  odl_connection_status OdlConnectionStatus @default(UNABLE_TO_CONNECT)
  last_synced_at        DateTime? // เวลาที่ sync ล่าสุดจาก ODL

  // ========= NETCONF Connection Fields (สำหรับ Mount) =========
  // (สำหรับอุปกรณ์ OpenFlow ฟิลด์เหล่านี้จะเป็น Null)
  netconf_host String? // IP/Hostname สำหรับ NETCONF connection
  netconf_port Int     @default(830) // NETCONF port (default: 830, SSH)

  configuration_template ConfigurationTemplate? @relation(fields: [configuration_template_id], references: [id], onDelete: SetNull)
  operatingSystem        OperatingSystem?       @relation(fields: [os_id], references: [id], onDelete: SetNull)
  policy                 Policy?                @relation(fields: [policy_id], references: [id], onDelete: SetNull)
  backup                 Backup?                @relation(fields: [backup_id], references: [id], onDelete: SetNull)
  localSite              LocalSite?             @relation(fields: [local_site_id], references: [id], onDelete: SetNull)

  // Many-to-Many relation with Tags
  tags Tag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  interfaces Interface[]

  @@index([serial_number])
  @@index([node_id])
  @@index([vendor])
}

// ========= NBI Enums =========
enum DeviceVendor {
  CISCO
  HUAWEI
  JUNIPER
  ARISTA
  OTHER
}

enum OdlConnectionStatus {
  CONNECTED
  CONNECTING
  UNABLE_TO_CONNECT
}

enum ManagementProtocol {
  NETCONF
  OPENFLOW
}

// ========= Interface (Network Interfaces) =========
model Interface {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String // เช่น GigabitEthernet0/1, eth0, Vlan10
  device_id   String          @db.Uuid
  device      DeviceNetwork   @relation(fields: [device_id], references: [id], onDelete: Cascade)
  label       String? // ชื่อย่อหรือป้ายกำกับ
  status      InterfaceStatus @default(DOWN) // ยังคงใช้ Enum เดิมของระบบ
  type        InterfaceType   @default(PHYSICAL)
  description String?

  // ODL Fields สำหรับทำ Flow Rule
  tp_id       String? @unique // Termination Point ID จาก ODL (เช่น "openflow:2:1")
  port_number BigInt? // หมายเลขพอร์ตที่ใช้เขียน rule (เช่น 1, 2, 3 หรือค่าใหญ่ๆ เช่น 4294967294)
  mac_address String? // MAC address ของ Interface (ถ้าจำเป็น)

  // phpIPAM Integration
  phpipam_address_id String? // phpIPAM address ID
  ip_address         String? // Cached IP from phpIPAM
  subnet_mask        String? // e.g., "255.255.255.0" or "/24"
  gateway            String? // Default gateway

  // Relations สำหรับ Topology L2
  links_source Link[] @relation("SourceInterface")
  links_target Link[] @relation("TargetInterface")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([device_id, name])
  @@index([device_id])
  @@index([status])
  @@index([tp_id])
}

//  โมเดลใหม่: สำหรับเก็บเส้นทางการเชื่อมต่อ (Topology Link)
model Link {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  link_id String @unique // ID สายเชื่อมจาก ODL (เช่น "openflow:2:2")

  source_interface_id String @db.Uuid
  target_interface_id String @db.Uuid

  source Interface @relation("SourceInterface", fields: [source_interface_id], references: [id], onDelete: Cascade)
  target Interface @relation("TargetInterface", fields: [target_interface_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source_interface_id])
  @@index([target_interface_id])
}

enum InterfaceStatus {
  UP
  DOWN
  ADMIN_DOWN
  TESTING
  OTHER
}

enum InterfaceType {
  PHYSICAL
  VIRTUAL
  LOOPBACK
  VLAN
  TUNNEL
  OTHER
}

enum StatusDevice {
  ONLINE
  OFFLINE
  MAINTENANCE
  OTHER
}

enum TypeDevice {
  SWITCH
  ROUTER
  FIREWALL
  ACCESS_POINT
  OTHER
}

model OperatingSystem {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  os_type     OsType  @unique @default(OTHER)
  description String?

  deviceNetworks DeviceNetwork[]
  backups        Backup[]
  files          OSFile[]

  // Many-to-Many relation with Tags
  tags Tag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([os_type])
}

// ========= OS File (สำหรับเก็บไฟล์ OS images) =========
model OSFile {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  os_id           String          @db.Uuid
  operatingSystem OperatingSystem @relation(fields: [os_id], references: [id], onDelete: Cascade)

  file_name String // ชื่อไฟล์ต้นฉบับ
  file_path String // Path ในระบบ (สำหรับ local storage) หรือ URL (สำหรับ cloud)
  file_size BigInt // ขนาดไฟล์ (bytes)
  file_type String? // MIME type (เช่น application/octet-stream)
  version   String? // Version ของ OS (15.7, 17.3)
  checksum  String? // MD5 หรือ SHA256 checksum สำหรับตรวจสอบความถูกต้อง

  uploaded_by    String? @db.Uuid
  uploadedByUser User?   @relation(fields: [uploaded_by], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([os_id])
  @@index([version])
}

model Tag {
  tag_id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tag_name    String   @unique
  description String?
  type        TypeTag  @default(other)
  color       String   @default("#3B82F6") // Hex color code สำหรับแสดงใน UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  operatingSystems       OperatingSystem[]
  deviceNetworks         DeviceNetwork[]
  configurationTemplates ConfigurationTemplate[]

  @@index([tag_name])
}

enum TypeTag {
  tag
  group
  other
}

enum OsType {
  CISCO_IOS
  CISCO_NXOS
  CISCO_ASA
  CISCO_Nexus
  CISCO_IOS_XR
  CISCO_IOS_XE
  HUAWEI_VRP
  OTHER
}

model LocalSite {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  site_code      String   @unique
  site_name      String?
  site_type      SiteType @default(DataCenter)
  building_name  String?
  floor_number   Int?
  rack_number    Int?
  address        String?
  address_detail String?
  sub_district   String?
  district       String?
  city           String?
  zip_code       String?
  country        String?

  deviceNetworks DeviceNetwork[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([site_code])
  @@index([site_name])
}

enum SiteType {
  DataCenter
  BRANCH
  OTHER
}

// ========= Policy =========
model Policy {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  policy_name      String  @unique
  description      String?
  parent_policy_id String? @db.Uuid

  parent_policy  Policy?         @relation("PolicyHierarchy", fields: [parent_policy_id], references: [id], onDelete: SetNull)
  child_policies Policy[]        @relation("PolicyHierarchy")
  deviceNetworks DeviceNetwork[]
  backups        Backup[]

  createdBy     String? @db.Uuid
  createdByUser User?   @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([policy_name])
}

enum PolicyType {
  NETWORK
  SECURITY
  OTHER
}

// ========= Backup =========
model Backup {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  backup_name String       @unique
  description String?
  policy_id   String?      @db.Uuid
  status      BackupStatus @default(ONLINE)
  auto_backup Boolean      @default(false)

  os_id           String?          @db.Uuid
  operatingSystem OperatingSystem? @relation(fields: [os_id], references: [id], onDelete: SetNull)

  policy         Policy?         @relation(fields: [policy_id], references: [id], onDelete: SetNull)
  deviceNetworks DeviceNetwork[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([backup_name])
}

enum BackupStatus {
  ONLINE
  OFFLINE
  MAINTENANCE
  OTHER
}

// ========= configuration Template =========
model ConfigurationTemplate {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  template_name String       @unique
  description   String?
  template_type TemplateType @default(OTHER)

  deviceNetworks DeviceNetwork[]

  // Many-to-Many relation with Tags
  tags Tag[]

  detail ConfigurationTemplateDetail?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([template_name])
}

model ConfigurationTemplateDetail {
  id                        String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  configuration_template_id String                @unique @db.Uuid
  configuration_template    ConfigurationTemplate @relation(fields: [configuration_template_id], references: [id], onDelete: Cascade)

  config_content String? @db.Text
  file_name      String?
  file_path      String?
  file_size      BigInt?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configuration_template_id])
}

enum TemplateType {
  NETWORK
  SECURITY
  OTHER
}